# 二、 文件系统实现

## 2.1 文件的物理结构（文件分配方式）
类似于内存分页，磁盘中的存储单元也会被分为一个个“块/磁盘块/物理块”。很多操作系统中，磁盘块的大小与内存块、页面的大小相同

内存与磁盘之间的数据交换（即读/写操作、磁盘I/O）都是以“块”为单位进行的。即每次读入一块，或每次写出一块

在内存管理中，进程的逻辑地址空间被分为一个一个页面同样的，在外存管理中，为了方便对文件数据的管理，文件的逻辑地址空间也被分为了一个一个的文件“块”。于是文件的逻辑地址也可以表示为（逻辑块号，块内地址）的形式。用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射

### 2.1.1 连续分配

连续分配方式要求每个文件在磁盘上占有一组连续的块。用户给出要访问的逻辑块号，操作系统找到该文件对应的目录项（FCB）——可以直接算出逻辑块号对应的物理块号，物理块号=起始块号+逻辑块号。还需要检查用户提供的逻辑块号是否合法（逻辑块号≥ 长度就不合法）因此**连续分配支持顺序访问和直接访问**（即随机访问）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-50294d94ad8217e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

读取某个磁盘块时，需要移动磁头。访问的两个磁盘块相隔越远，移动磁头所需时间就越长。**连续分配的文件在顺序读/写时速度最快，物理上采用连续分配的文件不方便拓展，且存储空间利用率低，会产生难以利用的磁盘碎片可以用紧凑来处理碎片，但是需要耗费很大的时间代价。。**

### 2.1.2 链接分配

链接分配采取离散分配的方式，可以为文件分配离散的磁盘块。分为隐式链接和显式链接两种。

#### 2.1.2.1 隐式链接

用户给出要访问的逻辑块号i，操作系统找到该文件对应的目录项（FCB）…从目录项中找到起始块号（即0号块），将0号逻辑块读入内存，由此知道1号逻辑块存放的物理块号，于是读入1号逻辑块，再找到2号逻辑块的存放位置……以此类推。因此，读入i号逻辑块，总共需要i+1次磁盘I/O。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-1c8349cd055775da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**采用链式分配（隐式链接）方式的文件，只支持顺序访问，不支持随机访问，查找效率低。另外，指向下一个盘块的指针也需要耗费少量的存储空间。但是，采用隐式链接的链接分配方式，很方便文件拓展。另外，所有的空闲磁盘块都可以被利用，不会有碎片问题，外存利用率高。**

#### 2.1.2.2 显式链接

把用于链接文件各物理块的指针显式地存放在一张表中。即文件分配表（FAT，File Allocation Table）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-af340dd8709135ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**一个磁盘仅设置一张FAT**。开机时，将FAT读入内存，并常驻内存。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此“物理块号”字段可以是隐含的。

从目录项中找到起始块号，若i>0，则查询内存中的文件分配表FAT，往后找到i号逻辑块对应的物理块号。**逻辑块号转换成物理块号的过程不需要读磁盘操作。**

**采用链式分配（显式链接）方式的文件，支持顺序访问，也支持随机访问**（想访问i号逻辑块时，并不需要依次访问之前的0 ~ i-1号逻辑块），**由于块号转换的过程不需要访问磁盘，因此相比于隐式链接来说，访问速度快很多。显然，显式链接也不会产生外部碎片，也可以很方便地对文件进行拓展。**

### 2.1.3 索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块（索引表的功能类似于内存管理中的页表——建立逻辑页面到物理页之间的映射关系）。索引表存放的磁盘块称为索引块。文件数据存放的磁盘块称为数据块。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-449bf6d418222e05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

在显式链接的链式分配方式中，文件分配表FAT是一个磁盘对应一张。而索引分配方式中，索引表是一个文件对应一张。可以用固定的长度表示物理块号[^3]，因此，索引表中的“逻辑块号”可以是隐含的。

用户给出要访问的逻辑块号i，操作系统找到该文件对应的目录项（FCB）…从目录项中可知索引表存放位置，将索引表从外存读入内存，并查找索引表即可只i号逻辑块在外存中的存放位置。

可见，**索引分配方式可以支持随机访问。文件拓展也很容易实现**（只需要给文件分配一个空闲块，并增加一个索引表项即可）但是**索引表需要占用一定的存储空间**

索引块的大小是一个重要的问题，每个文件必须有一个索引块，因此索引块应尽可能小，但索引块太小就无法支持大文件，可以采用以下机制：

- 链接方案：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。
- 多层索引：建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。**采用K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K + 1次读磁盘操作**
- 混合索引：多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表）。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-9007b993805c0e02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> 若某文件采用两层索引，则该文件的最大长度可以到256×256×1KB = 65,536 KB = 64MB
>
> 可根据逻辑块号算出应该查找索引表中的哪个表项。如：要访问1026号逻辑块，则1026/256 = 4，1026%256 = 2
>
> 因此可以先将一级索引表调入内存，查询4号表项，将其对应的二级索引表调入内存，再查询二级索引表的2号表项即可知道1026号逻辑块存放的磁盘块号了。
>
> 访问目标数据块，需要3次磁盘I/O。若采用三层索引，则文件的最大长度为256×256×256×1KB = 16GB
>
> 类似的，访问目标数据块，需要4次磁盘I/O

[^3]: 如：假设磁盘总容量为1TB=2^40^B，磁盘块大小为1KB，则共有2^30^个磁盘块，则可用4B表示磁盘块号

| 名称     | 介绍                                                         |
| -------- | ------------------------------------------------------------ |
| 链接方案 | 如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。缺点：若文件很大，索引表很长，就需要将很多个索引块链接起来。想要找到i号索引块，必须先依次读入0~i-1号索引块，这就导致磁盘I/O次数过多，查找效率低下。 |
| 多层索引 | 建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。采用K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K + 1次读磁盘操作。缺点：即使是小文件，访问一个数据块依然需要K+1次读磁盘。 |
| 混合索引 | 多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表）。优点：对于小文件来说，访问一个数据块所需的读磁盘次数更少。 |

>①要会根据多层索引、混合索引的结构计算出文件的最大长度（Key：各级索引表最大不能超过一个块）；②要能自己分析访问某个数据块所需要的读磁盘次数（Key：FCB中会存有指向顶级索引块的指针，因此可以根据FCB读入顶级索引块。每次读入下一级的索引块都需要一次读磁盘操作。另外，要注意题目条件——顶级索引块是否已调入内存）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-1a1b8bcf3c7269c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 2.2 文件存储空间管理

### 2.2.1 存储空间的划分与初始化

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-a5299242e0164d34.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 2.2.2 文件存储器空间管理

#### 2.2.2.1 空闲表法

空闲表法适用于“连续分配方式”。分配磁盘块：与内存管理中的动态分区分配很类似，为一个文件分配连续的存储空间。同样可采用首次适应、最佳适应、最坏适应等算法来决定要为文件分配哪个区间。回收磁盘块：与内存管理中的动态分区分配很类似，当回收某个存储区时需要有四种情况——①回收区的前后都没有相邻空闲区；②回收区的前后都是空闲区；③回收区前面是空闲区；④回收区后面是空闲区。总之，回收时需要注意表项的合并问题。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-ab0b5ca4ebd7a712.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 2.2.2.2 空闲链表法

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-020fe3dbea17012b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

操作系统保存着链头、链尾指针。如何分配：若某文件申请K个盘块，则从链头开始依次摘下K个盘块分配，并修改空闲链的链头指针。如何回收：回收的盘块依次挂到链尾，并修改空闲链的链尾指针。适用于离散分配的物理结构。为文件分配多个盘块时可能要重复多次操作

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-08f0fee51cbe5c70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

操作系统保存着链头、链尾指针。如何分配：若某文件申请K个盘块，则可以采用首次适应、最佳适应等算法，从链头开始检索，按照算法规则找到一个大小符合要求的空闲盘区，分配给文件。若没有合适的连续空闲块，也可以将不同盘区的盘块同时分配给一个文件，注意分配后可能要修改相应的链指针、盘区大小等数据。如何回收：若回收区和某个空闲盘区相邻，则需要将回收区合并到空闲盘区中。若回收区没有和任何空闲区相邻，将回收区作为单独的一个空闲盘区挂到链尾。**离散分配、连续分配都适用。为一个文件分配多个盘块时效率更高**

#### 2.2.2.3 位示图法

位示图：每个二进制位对应一个盘块。在本例中，“0”代表盘块空闲，“1”代表盘块已分配。位示图一般用连续的“字”来表示，如本例中一个字的字长是16位，字中的每一位对应一个盘块。因此可以用（字号，位号）对应一个盘块号。当然有的题目中也描述为（行号，列号）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-b5733b5df2dc9b72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

盘块号、字号、位号从0开始，若n表示字长，则

(字号,位号)=(i, j)的二进制位对应的盘块号b = ni + j

b号盘块对应的字号i = b/n，位号j = b%n

如何分配：若文件需要K个块，①顺序扫描位示图，找到K个相邻或不相邻的“0”；②根据字号、位号算出对应的盘块号，将相应盘块分配给文件；③将相应位设置为“1”。如何回收：①根据回收的盘块号计算出对应的字号、位号；②将相应二进制位设为“0”

#### 2.2.2.4 成组链接法

空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。UNIX系统中采用了成组链接法对磁盘空闲块进行管理。文件卷的目录区中专门用一个磁盘块作为“超级块”，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的“超级块”数据一致。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-e964f39f8e200d20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 2.3 文件的基本操作
### 2.3.1 创建文件

进行Create系统调用时，需要提供的几个主要参数：
1. 所需的外存空间大小（如：一个盘块，即1KB）
2. 文件存放路径（“D:/Demo”）
3. 文件名（这个地方默认为“新建文本文档.txt”）

操作系统在处理Create系统调用时，主要做了两件事：

1. 在外存中找到文件所需的空间（结合上小节学习的空闲链表法、位示图、成组链接法等管理策略，找到空闲空间）
2. 根据文件存放路径的信息找到该目录对应的目录文件（此处就是D:/Demo目录），在目录中创建该文件对应的目录项。目录项中包含了文件名、文件在外存中的存放位置等信息。

### 2.3.2 删除文件

进行Delete系统调用时，需要提供的几个主要参数：
1. 文件存放路径（“D:/Demo”）
2. 文件名（“test.txt”）

操作系统在处理Delete系统调用时，主要做了几件
事：
1. 根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的目录项。
2. 根据该目录项记录的文件在外存的存放位置、文件大小等信息，回收文件占用的磁盘块。（回收磁盘块时，根据空闲表法、空闲链表法、位图法等管理策略的不同，需要做不同的处理）
3. 从目录表中删除文件对应的目录项。

### 2.3.3 打开文件

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-82d5d82569f0368f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

在很多操作系统中，在对文件进行操作之前，要求用户先使用open系统调用“打开文件”，需要提供的几个主要参数：
1. 文件存放路径（“D:/Demo”）
2. 文件名（“test.txt”）
3. 要对文件的操作类型（如：r只读；rw读写等）

操作系统在处理open系统调用时，主要做了几件事：
1. 根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的的目录项，并检查该用户是否有指定的操作权限。
2. 将目录项复制到内存中的“打开文件表”中。并将对应表目的编号返回给用户。之后用户使用打开文件表的编号来指明要操作的文件。

### 2.3.4 关闭文件

进程使用完文件后，要“关闭文件”

操作系统在处理Close系统调用时，主要做了几件事：

1. 将进程的打开文件表相应表项删除
2. 回收分配给该文件的内存空间等资源
3. 系统打开文件表的打开计数器count减1，若count =0，则删除对应表项。

### 2.3.5 读文件

进程使用read系统调用完成写操作。需要指明是哪个文件（在支持“打开文件”操作的系统中，只需要提供文件在打开文件表中的索引号即可），还需要指明要读入多少数据（如：读入1KB）、指明读入的数据要放在内存中的什么位置。操作系统在处理read系统调用时，会从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域中。

### 2.3.6写文件

进程使用write系统调用完成写操作，需要指明是哪个文件（在支持“打开文件”操作的系统中，只需要提供文件在打开文件表中的索引号即可），还需要指明要写出多少数据（如：写出1KB）、写回外存的数据放在内存中的什么位置操作系统在处理write系统调用时，会从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存。

## 2.4 文件系统的层次结构

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-d042341278155305.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 用户接口：文件系统需要向上层的用户提供一些简单易用的功能接口。这层就是用于处理用户发出的系统调用请求（Read、Write、Open、Close等系统调用）
- 文件目录系统：用户是通过文件路径来访问文件的，因此这一层需要根据用户给出的文件路径找到相应的FCB或索引结点。所有和目录、目录项相关的管理工作都在本层完成，如：管理活跃的文件目录表、管理打开文件表等。
- 存取控制模块：为了保证文件数据的安全，还需要验证用户是否有访问权限。这一层主要完成了文件保护相关功能。
- 逻辑文件系统与文件信息缓冲区：用户指明想要访问文件记录号，这一层需要将记录号转换为对应的逻辑地址
- 物理文件系统：这一层需要把上一层提供的文件逻辑地址转换为实际的物理地址
- 辅助分配模块：负责文件存储空间的管理，即负责分配和回收存储空间
- 设备管理模块：直接与硬件交互，负责和硬件直接相关的一些管理工作。如：分配设备、分配设备缓冲区、磁盘调度、启动设备、释放设备等