# 二、 I/O核心子系统

## 2.1 I/O调度

II/O调度：用某种算法确定一个好的顺序来处理各个I/O请求。

如：磁盘调度（先来先服务算法、最短寻道优先算法、SCAN算法、C-SCAN算法、LOOK算法、C-LOOK算法）。当多个磁盘I/O请求到来时，用某种调度算法确定满足I/O请求的顺序。同理，打印机等设备也可以用先来先服务算法、优先级算法、短作业优先等算法来确定I/O调度顺序。

## 2.2 设备保护

操作系统需要实现文件保护功能，不同的用户对各个文件有不同的访问权限（如：只读、读和写等）。在UNIX系统中，设备被看做是一种特殊的文件，每个设备也会有对应的FCB。当用户请求访问某个设备时，系统根据FCB中记录的信息来判断该用户是否有相应的访问权限，以此实现“设备保护”的功能。

## 2.3 假脱机技术（SPOOLing技术）
批处理阶段引入了脱机输入/输出技术（用磁带完成）：引入脱机技术后，缓解了CPU与慢速I/O设备的速度矛盾。另一方面，即使CPU在忙碌，也可以提前将数据输入到磁带；即使慢速的输出设备正在忙碌，也可以提前将数据输出到磁带。

在外围控制机的控制下，慢速输入设备的数据先被输入到更快速的磁带上。之后主机可以从快速的磁带上读入数据，从而缓解了速度矛盾

“假脱机技术”，又称“SPOOLing技术”是用软件的方式模拟脱机技术。SPOOLing系统的组成如下：

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-8862ba24f15c8250.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

要实现SPOOLing技术，必须要有多道程序技术的支持。系统会建立“输入进程”和“输出进程”。

- “输入进程”模拟脱机输入时的外围控制机，在输入进程的控制下，“输入缓冲区”用于暂存从输入设备输入的数据，之后再转存到输入井中
- “输出进程”模拟脱机输出时的外围控制机，在输出进程的控制下，“输出缓冲区”用于暂存从输出井送来的数据，之后再传送到输出设备上

在磁盘上开辟出两个存储区域——“输入井”和“输出井”

- “输入井”模拟脱机输入时的磁带，用于收容I/O设备输入的数据
- “输出井”模拟脱机输出时的磁带，用于收容用户进程输出的数据

SPOOLing技术可以把一台物理设备虚拟成逻辑上的多台设备，可将独占式设备改造成共享设备。

>独占式设备——只允许各个进程串行使用的设备。一段时间内只能满足一个进程的请求。
>共享设备——允许多个进程“同时”使用的设备（宏观上同时使用，微观上可能是交替使用）。可以同时满足多个进程的使用请求。

## 2.4 设备的分配与回收
### 2.4.1 设备的固有属性

设备的固有属性可分为三种：独占设备、共享设备、虚拟设备。

- 独占设备：一个时段只能分配给一个进程（如打印机）
- 共享设备：可同时分配给多个进程使用（如磁盘），各进程往往是宏观上同时共享使用设备，而微观上交替使用。
- 虚拟设备：用SPOOLing技术将独占设备改造成虚拟的共享设备，可同时分配给多个进程使用（如采用SPOOLing技术实现的共享打印机）

### 2.4.2 设备分配

从进程运行的安全性上考虑，设备分配有两种方式：

- 安全分配方式：为进程分配一个设备后就将进程阻塞，本次I/O完成后才将进程唤醒。一个时段内每个进程只能使用一个设备

优点：破坏了“请求和保持”条件，不会死锁
缺点：对于一个进程来说，CPU和I/O设备只能串行工作

- 不安全分配方式：进程发出I/O请求后，系统为其分配I/O设备，进程可继续执行，之后还可以发出新的I/O请求。只有某个I/O请求得不到满足时才将进程阻塞。一个进程可以同时使用多个设备

优点：进程的计算任务和I/O任务可以并行处理，使进程迅速推进
缺点：有可能发生死锁（死锁避免、死锁的检测和解除）

设备的分配方式：

- 静态分配：进程运行前为其分配全部所需资源，运行结束后归还资源。破坏了“请求和保持”条件，不会发生死锁
- 动态分配：进程运行过程中动态申请设备资源

### 2.4.3 设备分配管理中的数据结构

设备分配管理中的数据结构有

- 设备控制表（DCT）：系统为每个设备配置一张DCT，用于记录设备情况
- 控制器控制表（COCT）：每个设备控制器都会对应一张COCT。操作系统根据COCT的信息对控制器进行操作和管理。
- 通道控制表（CHCT）：每个通道都会对应一张CHCT。操作系统根据CHCT的信息对通道进行操作和管理。
- 系统设备表（SDT）：记录了系统中全部设备的情况，每个设备对应一个表目。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-288faebae236d2f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-9b13f73e58bf0b4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 2.4.4 设备分配步骤的步骤及改进

设备分配步骤的步骤：

1. 根据进程请求的物理设备名查找SDT（注：物理设备名是进程请求分配设备时提供的参数）
2. 根据SDT找到DCT，若设备忙碌则将进程PCB挂到设备等待队列中，不忙碌则将设备分配给进程。
3. 根据DCT找到COCT，若控制器忙碌则将进程PCB挂到控制器等待队列中，不忙碌则将控制器分配给进程。
4. 根据COCT找到CHCT，若通道忙碌则将进程PCB挂到通道等待队列中，不忙碌则将通道分配给进程。

缺点：

1. 用户编程时必须使用“物理设备名”，底层细节对用户不透明，不方便编程
2. 若换了一个物理设备，则程序无法运行
3. 若进程请求的物理设备正在忙碌，则即使系统中还有同类型的设备，进程也必须阻塞等待

改进方法：建立逻辑设备名与物理设备名的映射机制，用户编程时只需提供逻辑设备名

1. 根据进程请求的逻辑设备名查找SDT（注：用户编程时提供的逻辑设备名其实就是“设备类型”）
2. 查找SDT，找到用户进程指定类型的、并且空闲的设备，将其分配给该进程。操作系统在逻辑设备表（LUT）中新增一个表项。
3. 根据DCT找到COCT，若控制器忙碌则将进程PCB挂到控制器等待队列中，不忙碌则将控制器分配给进程。
4. 根据COCT找到CHCT，若通道忙碌则将进程PCB挂到通道等待队列中，不忙碌则将通道分配给进程。

某用户进程第一次使用设备时使用逻辑设备名向操作系统发出请求，操作系统根据用户进程指定的设备类型（逻辑设备名）查找系统设备表，找到一个空闲设备分配给进程，并在LUT中增加相应表项。如果之后用户进程再次通过相同的逻辑设备名请求使用设备，则操作系统通过LUT表即可知道用户进程实际要使用的是哪个物理设备了，并且也能知道该设备的驱动程序入口地址。

- 整个系统只有一张LUT：各用户所用的逻辑设备名不允许重复，适用于单用户操作系统
- 每个用户一张LUT：不同用户的逻辑设备名可重复，适用于多用户操作系统

## 2.5 缓冲区管理

### 2.5.1 缓冲区的概念

缓冲区是一个存储区域，可以由专门的硬件寄存器组成，也可利用内存作为缓冲区。使用硬件作为缓冲区的成本较高，容量也较小，一般仅用在对速度要求非常高的场合（如存储器管理中所用的联想寄存器，由于对页表的访问频率极高，因此使用速度很快的联想寄存器来存放页表项的副本）

一般情况下，更多的是利用内存作为缓冲区，“设备独立性软件”的缓冲区管理就是要组织管理好这些缓冲区

缓冲区的作用

- 缓和CPU与I/O设备之间速度不匹配的矛盾
- 减少对CPU的中断频率，放宽对CPU中断响应时间的限制
- 解决数据粒度不匹配的问题
- 提高CPU与I/O设备之间的并行性

根据系统设置的缓冲区个数，缓冲技术可以分为单缓冲、双缓冲、循环缓冲区

### 2.5.2 单缓冲

假设某用户进程请求某种块设备读入若干块的数据。若采用单缓冲的策略，操作系统会在主存中为其分配一个缓冲区（若题目中没有特别说明，一个缓冲区的大小就是一个块）。

>注意：当缓冲区数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出；当缓冲区为空时，可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出。

T>C，因此CPU处理完数据后暂时不能将下一块数据传送到工作区，必须等待缓冲区中冲满数据

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-d785abe492ac0e33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

单缓冲区处理每块数据的用时为$max\{C,T\}+M$

### 2.5.3 双缓冲

假设某用户进程请求某种块设备读入若干块的数据。若采用双缓冲的策略，操作系统会在主存中为其分配两个缓冲区（若题目中没有特别说明，一个缓冲区的大小就是一个块）

双缓冲题目中，假设初始状态为：工作区空，其中一个缓冲区满，另一个缓冲区空，假设T>C+M，时间为T

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-09dc7f1c05e6c81c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

假设T<C+M，时间为C+M

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-0e21feb2d526cadc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

采用双缓冲策略，处理一个数据块的平均耗时为$max\{T, C+M\}$

若两个相互通信的机器只设置单缓冲区，在任一时刻只能实现数据的单向传输。

> 管道通信中的“管道”其实就是缓冲区。要实现数据的双向传输，必须设置两个管道

### 2.5.4 循环缓冲区

将多个大小相等的缓冲区链接成一个循环队列。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-196a716280f6825e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 2.5.5 缓冲池

缓冲池由系统中共用的缓冲区组成。这些缓冲区按使用状况可以分为：空缓冲队列、装满输入数据的缓冲队列（输入队列）、装满输出数据的缓冲队列（输出队列）。

另外，根据一个缓冲区在实际运算中扮演的功能不同，又设置了四种工作缓冲区：用于收容输入数据的工作缓冲区（hin）、用于提取输入数据的工作缓冲区（sin）、用于收容输出数据的工作缓冲区（hout）、用于提取输出数据的工作缓冲区（sout）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-cf63a15227025c29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

从空缓冲队列中取出一块作为收容输入数据的工作缓冲区（hin）。冲满数据后将缓冲区挂到输入队列队尾