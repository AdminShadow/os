# 三、操作系统的运行环境

## 3.1 操作系统的运行机制

CPU 上会运行两种程序，一种是操作系统内核程序，一种是应用程序

内核是操作系统最重要最核心的部分，也是最接近硬件的部分

> 操作系统的功能未必都在内核中，如图形化用户界面GUI

应用程序只能使用“非特权指令”，如：加法指令、减法指令等

操作系统内核作为“管理者”，有时会让CPU执行一些“特权指令”，如：内存清零指令。这些指令影响重大，只允许“管理者”——即操作系统内核来使用

CPU 有两种状态，“内核态”和“用户态”

- 处于内核态时，说明此时正在运行的是内核程序，此时可以执行特权指令
- 处于用户态时，说明此时正在运行的是应用程序，此时只能执行非特权指令

内核态→用户态：执行一条特权指令——修改PSW的标志位为“用户态”，这个动作意味着操作系统将主动让出CPU使用权

用户态→内核态：由“中断”引发，硬件自动完成变态过程，触发中断信号意味着操作系统将强行夺回CPU的使用权

## 3.2 中断和异常的概念

“中断”会使CPU由用户态变为内核态，使操作系统重新夺回对CPU的控制权

**“中断”是让操作系统内核夺回CPU使用权的唯一途径**

中断可以分为内中断和外中断

- 内中断：与当前执行的指令有关，中断信号来源于CPU内部，也称异常、例外
  - 陷阱、陷入：由陷入指令引发，是应用程序故意引发的
  - 故障：由错误条件引起的，可能被内核程序修复。内核程序修复故障后会把CPU使用权还给应用程序，让它继续执行下去。如：缺页故障。
  - 终止：由致命错误引起，内核程序无法修复该错误，因此一般不再将CPU使用权还给引发终止的应用程序，而是直接终止该应用程序。如：整数除0、非法使用特权指令
- 外中断：与当前执行的指令无关，中断信号来源于CPU外部
  - 时钟中断：由时钟部件发来的中断信号
  - I/O中断请求：由输入/输出设备发来的中断信号

> 中断处理过程见计组第七章

## 3.3 系统调用

“系统调用”是操作系统提供给应用程序（程序员/编程人员）使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求获得操作系统内核的服务

系统调用的功能可以分为

- 设备管理：完成设备的请求/释放/启动等功能
- 文件管理：完成文件的读/写/创建/删除等功能
- 进程控制：完成进程的创建/撤销/阻塞/唤醒等功能
- 进程通信：完成进程之间的消息传递/信号传递等功能
- 内存管理：完成内存的分配/回收等功能

应用程序通过系统调用请求操作系统的服务。而系统中的各种共享资源都由操作系统内核统一掌管，因此凡是与共享资源有关的操作（如存储分配、I/O操作、文件管理等），都必须通过系统调用的方式向操作系统内核提出服务请求，由操作系统内核代为完成。这样可以保证系统的稳定性和安全性，防止用户进行非法操作。

> 1. 陷入指令是在用户态执行的，执行陷入指令之后立即引发一个内中断，使CPU进入核心态
> 2. 发出系统调用请求是在用户态，而对系统调用的相应处理在核心态下进行