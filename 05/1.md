# 一、 I/O管理概述

## 1.1 I/O设备

“I/O”就是“输入/输出”（Input/Output）I/O设备就是可以将数据输入到计算机，或者可以接收计算机输出数据的外部设备，属于计算机中的硬件部件。

计算机系统中的I/O设备按使用特性可分为

- 人机交互类外部设备，如鼠标、键盘，用于人机交互，数据传输速度慢
- 存储设备，如移动硬盘、光盘等，用于数据存储，数据传输速度快
- 网络通信设备，如调制解调器等，用于网络通信，数据传输速度介于上述二者之间

按传输速率分类可分为

- 低速设备，鼠标、键盘等，传输速率为每秒几个到几百字节
- 中速设备，如激光打印机等，传输速率为每秒数千至上万个字节
- 高速设备，如磁盘等，传输速率为每秒数千字节至千兆字节的设备

按信息交换的单位分类

- 块设备：如磁盘等，数据传输的基本单位是“块”，传输速率较高，可寻址，即对它可随机地读/写任一块
- 字符设备：鼠标、键盘等，数据传输的基本单位是字符。传输速率较慢，不可寻址，在输入/输出时常采用中断驱动方式

## 1.2 I/O控制方式

### 1.2.1 程序直接控制方式

完成一次读/写操作的流程（以读操作为例）

1. CPU向控制器发出读指令。于是设备启动，并且状态寄存器设为1（未就绪）
2. 轮询检查控制器的状态（其实就是在不断地执行程序的循环，若状态位一直是1，说明设备还没准备好要输入的数据，于是CPU会不断地轮询）
3. 输入设备准备好数据后将数据传给控制器，并报告自身状态
4. 控制器将输入的数据放到数据寄存器中，并将状态改为0（已就绪）
5. CPU发现设备已就绪，即可将数据寄存器中的内容读入CPU的寄存器中，再把CPU寄存器中的内容放入内存
6. 若还要继续读入数据，则CPU继续发出读指令

读操作（数据输入）：I/O设备→CPU→内存
写操作（数据输出）：内存→CPU→I/O设备
每个字的读/写都需要CPU的帮助

优点：实现简单。在读/写指令之后，加上实现循环检查的一系列指令即可（因此才称为“程序直接控制方式”）
缺点：CPU和I/O设备只能串行工作，CPU需要一直轮询检查，长期处于“忙等”状态，CPU利用率低。

### 1.2.2 中断驱动方式

引入中断机制。由于I/O设备速度很慢，因此在CPU发出读/写命令后，可将等待I/O的进程阻塞，先切换到别的进程执行。当I/O完成后，控制器会向CPU发出一个中断信号，CPU检测到中断信号后，会保存当前进程的运行环境信息，转去执行中断处理程序处理该中断。处理中断的过程中，CPU从I/O控制器读一个字的数据传送到CPU寄存器，再写入主存。接着，CPU恢复等待I/O的进程（或其他进程）的运行环境，然后继续执行。

>①CPU会在每个指令周期的末尾检查中断；
>②中断处理过程中需要保存、恢复进程的运行环境，
>这个过程是需要一定时间开销的。可见，如果中断发生的频率太高，也会降低系统性能

读操作（数据输入）：I/O设备→CPU→内存
写操作（数据输出）：内存→CPU→I/O设备

优点：与“程序直接控制方式”相比，在“中断驱动方式”中，I/O控制器会通过中断信号主动报告I/O已完成，CPU不再需要不停地轮询。CPU和I/O设备可并行工作，CPU利用率得到明显提升。
缺点：每个字在I/O设备与内存之间的传输，都需要经过CPU。而频繁的中断处理会消耗较多的CPU时间。

### 1.2.3 DMA方式

与“中断驱动方式”相比，DMA方式（Direct Memory Access，直接存储器存取。主要用于块设备的I/O控制）有这样几个改进：

- 数据的传送单位是“块”。不再是一个字、一个字的传送；
- 数据的流向是从设备直接放入内存，或者从内存直接到设备。
- 仅在传送一个或多个数据块的开始和结束时，才需要CPU干预。

> 具体见计组第七章

优点：数据传输以“块”为单位，CPU介入频率进一步降低。数据的传输不再需要先经过CPU再写入内存，数据传输效率进一步增加。CPU和I/O设备的并行性得到提升。
缺点：CPU每发出一条I/O指令，只能读/写一个或多个连续的数据块。如果要读/写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU要分别发出多条I/O指令，进行多次中断处理才能完成。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-37fb3e9a0ce8c812.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 1.2.4 通道控制方式

通道：一种硬件，可以理解为是“小型CPU”。通道可以识别并执行一系列通道指令

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-ebc9c8d696f1a6be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

与CPU相比，通道可以执行的指令很单一，并且通道程序是放在主机内存中的，也就是说通道与CPU共享内存，CPU干预的频率
极低，通道会根据CPU的指示执行相应的通道程序，只有完成一组数据块的读/写后才需要发出中断信号，请求CPU干预。

缺点：实现复杂，需要专门的通道硬件支持
优点：CPU、通道、I/O设备可并行工作，资源利用率很高。

| 名称             | 完成一次读写的过程                                           | CPU干预频率 | 每次I/O的数据传输单位 | 数据流向                        |
| ---------------- | ------------------------------------------------------------ | ----------- | --------------------- | ------------------------------- |
| 程序直接控制方式 | CPU发出I/O命令后需要不断轮询                                 | 极高        | 字                    | 设备→CPU→内存<br/>内存→CPU→设备 |
| 中断驱动方式     | CPU发出I/O命令后可以做其他事，本次I/O完成后设备控制器发出中断信号 | 高          | 字                    | 设备→CPU→内存<br/>内存→CPU→设备 |
| DMA方式          | CPU发出I/O命令后可以做其他事，本次I/O完成后DMA控制器发出中断信号 | 中          | 块                    | 设备→内存<br/>内存→设备         |
| 通道控制方式     | CPU发出I/O命令后可以做其他事。通道会执行通道程序以完成I/O，完成后通道向CPU发出中断信号 | 低          | 一组块                | 设备→内存<br/>内存→设备         |

## 1.3 I/O子系统的层次结构

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-7f82bfe59c92470a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 用户层软件：用户层软件实现了与用户交互的接口，用户可直接使用该层提供的、与I/O操作相关的库函数对设备进行操作。操作系统向外提供的一系列系统调用，但是由于系统调用的格式严格，使用麻烦，因此在用户层上封装了一系列更方便的库函数接口供用户使用
- 设备独立性软件：设备独立性软件，又称设备无关性软件。与设备的硬件特性无关的功能几乎都在这一层实现。主要实现的功能：①向上层提供统一的调用接口②设备的保护③差错处理④设备的分配与回收⑤数据缓冲区管理⑥建立逻辑设备名到物理设备名的映射关系；根据设备类型选择调用相应的驱动程序

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-f80b48c3fb30c818.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

操作系统系统可以采用两种方式管理逻辑设备表（LUT）：

第一种方式，整个系统只设置一张LUT，这就意味着所有用户不能使用相同的逻辑设备名，因此这种方式只适用于单用户操作系统。
第二种方式，为每个用户设置一张LUT，各个用户使用的逻辑设备名可以重复，适用于多用户操作系统。系统会在用户登录时为其建立一个用户管理进程，而LUT就存放在用户管理进程的PCB中。

- 设备驱动程序：主要负责对硬件设备的具体控制，将上层发出的一系列命令（如read/write）转化成特定设备“能听得懂”的一系列操作。包括设置设备寄存器；检查设备状态等.不同的I/O设备有不同的硬件特性，具体细节只有设备的厂家才知道。因此厂家需要根据设备的硬件特性设计并提供相应的驱动程序。
- 中断处理程序:当I/O任务完成时，I/O控制器会发送一个中断信号，系统会根据中断信号类型找到相应的中断处理程序并执行。
- 硬件：执行I/O操作，有机械部件、电子部件组成

> 直接涉及到硬件具体细节、且与中断无关的操作肯定是在设备驱动程序层完成的；没有涉及硬件的、对各种设备都需要进行的管理工作都是在设备独立性软件层完成的）

