# 一、 文件系统基础

文件—就是一组有意义的信息/数据集合

## 1.1 文件的概念

### 1.1.1 文件的属性

- 文件名：由创建文件的用户决定文件名，主要是为了方便用户找到文件，同一目录下不允许有重名文件。
- 标识符：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称。
- 类型：指明文件的类型
- 位置：文件存放的路径（让用户使用）、在外存中的地址（操作系统使用，对用户不可见）
- 大小：指明文件大小

- 保护：对文件进行保护的访问控制信息
- 时间、日期、用户标识：创建时间、上次修改时间，文件所有者信息

### 1.1.2 文件的基本操作

文件属于抽象数据类型。为了恰当地定义文件，需要考虑有关文件的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、搠除和截断等操作。

1. 创建文件。创建文件有两个必要步骤:一是在文件系统中为文件找到空间;二是在目录中为新文件创建条目，该条目记录文件名称、在文件系统中的位置及其他可能的信息。
2. 写文件。为了写文件，执行一个系统调用，指明文件名称和要写入文件的内容。对于给定文件名称，系统搜索目录以查找文件位置。系统必须为该文件维护一个写位置的指针。每当发生写操作时，便更新写指针。
3. 读文件。为了读文件，执行一个系统调用，指明文件名称和要读入文件块的内存位置。同样，需要搜索目录以找到相关目录项，系统维护一个读位置的指针。每当发生读操作时，更新读指针。一个进程通常只对一个文件读或写，因此当前操作位置可作为每个进程当前文件位置的指针。由于读和写操作都使用同一指针，因此节省了空间，也降低了系统复杂度。
4. 文件重定位(文件寻址)。按某条件搜索目录，将当前文件位置设为给定值，并且不会读、写文件。
5. 删除文件。先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件所占用的存储空间。
6. 截断文件。允许文件所有属性不变，并删除文件内容，即将其长度设为О并释放其空间。这6个基本操作可以组合起来执行其他文件操作。例如，一个文件的复制，可以创建新文件、从旧文件读出并写入新文件。

## 1.2 文件的逻辑结构

所谓的“逻辑结构”，就是指在用户看来，文件内部的数据应该是如何组织起来的。而“物理结构”指的是在操作系统看来，文件的数据是如何存放在外存中的。

### 1.2.1 无结构文件

无结构文件：文件内部的数据就是一系列二进制流或字符流组成。又称“流式文件”

文件内部的数据其实就是一系列字符流，没有明显的结构特性。因此也不用探讨无结构文件的“逻辑结构”问题。

### 1.2.2 有结构文件

有结构文件：由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。[^1]一般来说，每条记录有一个数据项可作为关键字。根据各条记录的长度（占用的存储空间）是否相等，又可分为定长记录和可变长记录两种。有结构文件按记录的组织形式可以分为：

1. 顺序文件：文件中的记录一个接一个地顺序排列（逻辑上），记录可以是定长的或可变长的。各个记录在物理上可以顺序存储或链式存储。顺序文件有以下两种结构：第一种是串结构，记录之间的顺序与关键字无关，通常按照记录存入的时间决定记录的顺序；第二个是顺序结构，指文件中的所有记录按关键字顺序排序
2. 索引文件：索引表本身是定长记录的顺序文件。因此可以快速找到第i个记录对应的索引项。可将关键字作为索引号内容，若按关键字顺序排列，则还可以支持按照关键字折半查找。每当要增加/删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合。另外，可以用不同的数据项建立多个索引表。[^2]
![图片.png](https://upload-images.jianshu.io/upload_images/26868451-567a70e36e4ef964.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
3. 索引顺序文件:索引顺序文件是索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立一张索引表，但不同的是：并不是每个记录对应一个索引表项，而是一组记录对应一个索引表项。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-782dc8dc14ce85d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

对于含有N条记录的顺序文件，查找某关键字值的记录时，平均需要查找N/2次。在索引顺序文件中，假设N条记录分为√N组，索引表中有√N个表项，每组有√N条记录，在查找某关键字值的记录时，先顺序查找索引表，需要查找√N /2次，然后在主文件中对应的组中顺序查找，也需要查找√N/2次，因此共需查找√N/2+√N/2=√N次。显然，索引顺序文件提高了查找效率，若记录数很多，则可采用两级或多级索引

> 顺序文件对查找、修改、增加或删除单条记录的操作比较困难
>
> 索引文件每个记录对应一个索引表项，因此索引表可能会很大。

[^1]: 如：数据库表文件。
[^2]: 如：学生信息表中，可用关键字“学号”建立一张索引表。也可用“姓名”建立一张索引表。这样就可以根据“姓名”快速地检索文件了。

## 1.3 目录结构

### 1.3.1 文件控制块

FCB的有序集合称为“文件目录”，一个FCB就是一个文件目录项。FCB中包含了文件的基本信息（文件名、物理地址、逻辑结构、物理结构等），存取控制信息（是否可读/可写、禁止访问的用户名单等），使用信息（如文件的建立时间、修改时间等）。最重要，最基本的还是文件名、文件存放的物理地址。

### 1.3.2 目录结构

对目录的操作如下：

- 搜索：当用户要使用一个文件时，系统要根据文件名搜索目录，找到该文件对应的目录项
- 创建文件：创建一个新文件时，需要在其所属的目录中增加一个目录项
- 删除文件：当删除一个文件时，需要在目录中删除相应的目录项
- 显示目录：用户可以请求显示目录的内容，如显示该目录中的所有文件及相应属性
- 修改目录：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项

操作的时候，可以有以下几种目录结构：

1. 单级目录结构

早期操作系统并不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-93e409fa9371de55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

单级目录实现了“按名存取”，但是不允许文件重名。在创建一个文件时，需要先检查目录表中有没有重名文件，确定不重名后才能允许建立文件，并将新文件对应的目录项插入目录表中。显然，**单级目录结构不适用于多用户操作系统。**

2. 两级目录结构

早期的多用户操作系统，采用两级目录结构。分为主文件目录（MFD，Master File Directory）和用户文件目录（UFD，User Flie Directory）。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-0cc3525e0110c217.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

允许不同用户的文件重名。文件名虽然相同，但是对应的其实是不同的文件。两级目录结构允许不同用户的文件重名，也可以在目录上实现实现访问限制（检查此时登录的用户名是否匹配）。但是两级目录结构依然缺乏灵活性，用户不能对自己的文件进行分类

3. 多级目录结构

用户（或用户进程）要访问某个文件时要用文件路径名标识文件，文件路径名是个字符串。各级目录之间用“/”隔开。从根目录出发的路径称为绝对路径。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-eb07a01162133565.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

系统根据绝对路径一层一层地找到下一级目录。刚开始从外存读入根目录的目录表；找到目录的存放位置后，从外存读入对应的目录表；再找到目录的存放位置，再从外存读入对应目录表；最后才找到文件的存放位置。整个过程需要3次读磁盘I/O操作。

很多时候，用户会连续访问同一目录内的多个文件，显然，每次都从根目录开始查找，是很低效的。因此可以设置一个“当前目录”。此时已经打开了的目录文件，也就是说，这张目录表已调入内存，那么可以把它设置为“当前目录”。当用户想要访问某个文件时，可以使用从当前目录出发的“相对路径”

可见，引入“当前目录”和“相对路径”后，磁盘I/O的次数减少了。这就提升了访问文件的效率。

树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，树形结构不便于实现文件的共享。为此，提出了“无环图目录结构”。

4. 无环图目录结构

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-d2584bce91e3b031.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

可以用不同的文件名指向同一个文件，甚至可以指向同一个目录（共享同一目录下的所有内容）。需要为每个共享结点设置一个共享计数器，用于记录此时有多少个地方在共享该结点。用户提出删除结点的请求时，只是删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点。只有共享计数器减为0时，才删除结点。

> 共享文件不同于复制文件。在共享文件中，由于各用户指向的是同一个文件，因此只要其中一个用户修改了文件数据，那么所有用户都可以看到文件数据的变化。

### 1.3.3 索引结点

其实在查找各级目录的过程中只需要用到“文件名”这个信息，只有文件名匹配时，才需要读出文件的其他信息。因此可以考虑让目录表“瘦身”来提升效率。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-f5c31b0b149dafa7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> 假设一个FCB是64B，磁盘块的大小为1KB，则每个盘块中只能存放16个FCB。若一个文件目录中共有640个目录项，则共需要占用640/16 = 40个盘块。因此按照某文件名检索该目录，平均需要查询320个目录项，平均需要启动磁盘20次（每次磁盘I/O读入一块）。
>
> 若使用索引结点机制，文件名占14B，索引结点指针站2B，则每个盘块可存放64个目录项，那么按文件名检索目录平均只需要读入320/64 = 5个磁盘块。
>
> 显然，这将大大提升文件检索速度。

当找到文件名对应的目录项时，才需要将索引结点调入内存，索引结点中记录了文件的各种信息，包括文件在外存中的存放位置，根据“存放位置”即可找到文件。存放在外存中的索引结点称为“磁盘索引结点”，当索引结点放入内存后称为“内存索引结点”。相比之下内存索引结点中需要增加一些信息，比如：文件是否被修改、此时有几个进程正在访问该文件等。

### 1.3.4 文件保护

1. 口令保护

为文件设置一个“口令”（如：abc112233），用户请求访问该文件时必须提供“口令”。

优点：保存口令的空间开销不多，验证口令的时间开销也很小。

缺点：正确的“口令”存放在系统内部，不够安全。

2. 加密保护

使用某个“密码”对文件进行加密，在访问文件时需要提供正确的“密码”才能对文件进行正确的解密。[^Eg]

优点：保密性强，不需要在系统中存储“密码”

缺点：编码/译码，或者说加密/解密要花费一定时间。

3. 访问控制

在每个文件的FCB（或索引结点）中增加一个访问控制列表（Access-Control List, ACL），该表中记录了各个用户可以对该文件执行哪些操作。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-813b06f2857e1535.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

有的计算机可能会有很多个用户，因此访问控制列表可能会很大，可以用精简的访问列表解决这个问题

精简的访问列表：以“组”为单位，标记各“组”用户可以对文件执行哪些操作。当某用户想要访问文件时，系统会检查该用户所属的分组是否有相应的访问权限。

[^Eg]: 如加密算法—异或加密

### 1.3.5 文件共享

#### 1.3.5.1 基于索引结点的共享方式(硬链接)

索引结点，是一种文件目录瘦身策略。由于检索文件时只需用到文件名，因此可以将除了文件名之外的其他信息放到索引结点中。这样目录项就只需要包含文件名、索引结点指针。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-fb16b1a917604052.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

索引结点中设置一个链接计数变量count，用于表示链接到本索引结点上的用户目录项数。

- 若count = 2，说明此时有两个用户目录项链接到该索引结点上，或者说是有两个用户在共享此文件。若某个用户决定“删除”该文件，则只是要把用户目录中与该文件对应的目录项删除，且索引结点的count值减1。
- 若count>0，说明还有别的用户要使用该文件，暂时不能把文件数据删除，否则会导致指针悬空。
- 当count = 0时系统负责删除文件。

#### 1.3.5.2 基于符号链的共享方式（软链接）

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-7ed41530ea3e6258.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

当User3访问“ccc”时，操作系统判断文件“ccc”属于Link类型文件，于是会根据其中记录的路径层层查找目录，最终找到User1的目录表中的“aaa”表项，于是就找到了文件1的索引结点。